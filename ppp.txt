import streamlit as st
import sqlite3
import os
import time
import uuid
import threading
import datetime
import extra_streamlit_components as stx
from datetime import datetime, timedelta, timezone
import httpx
import requests
import re
import random
import string
import html
from urllib.parse import quote
from retrying import retry

# ==========================================
# 0. æ•°æ®åº“ç®¡ç† (SQLite3)
# ==========================================
DB_FILE = "linkchanger.db"

class DBManager:
    def __init__(self):
        self._init_db()

    def _get_conn(self):
        return sqlite3.connect(DB_FILE, check_same_thread=False)

    def _init_db(self):
        conn = self._get_conn()
        c = conn.cursor()
        c.execute('''CREATE TABLE IF NOT EXISTS users (
                        uid TEXT PRIMARY KEY,
                        name TEXT,
                        pin TEXT,
                        wechat TEXT,
                        q_cookie TEXT,
                        b_cookie TEXT,
                        q_img TEXT,
                        b_img TEXT,
                        b_pwd TEXT,
                        created_at TEXT
                    )''')
        conn.commit()
        conn.close()

    def add_user(self, uid, name, pin, wechat):
        conn = self._get_conn()
        c = conn.cursor()
        try:
            created_at = datetime.now().strftime("%Y-%m-%d %H:%M")
            c.execute("INSERT INTO users (uid, name, pin, wechat, q_cookie, b_cookie, q_img, b_img, b_pwd, created_at) VALUES (?, ?, ?, ?, '', '', '', '', '', ?)",
                      (uid, name, pin, wechat, created_at))
            conn.commit()
            return True, "æ·»åŠ æˆåŠŸ"
        except sqlite3.IntegrityError:
            return False, "UID å·²å­˜åœ¨ï¼Œè¯·æ¢ä¸€ä¸ª"
        except Exception as e:
            return False, f"æ•°æ®åº“é”™è¯¯: {e}"
        finally:
            conn.close()

    def get_user(self, uid):
        conn = self._get_conn()
        c = conn.cursor()
        c.execute("SELECT * FROM users WHERE uid=?", (uid,))
        row = c.fetchone()
        conn.close()
        if row:
            return {
                "uid": row[0], "name": row[1], "pin": row[2], "wechat": row[3],
                "q": row[4], "b": row[5], 
                "q_img": row[6], "b_img": row[7], "b_pwd": row[8]
            }
        return None

    def get_all_users(self):
        conn = self._get_conn()
        c = conn.cursor()
        c.execute("SELECT uid, name, wechat, created_at, q_cookie, b_cookie FROM users")
        rows = c.fetchall()
        conn.close()
        return rows 

    def update_user_profile(self, uid, name, pin, q, b, q_img, b_img, b_pwd):
        conn = self._get_conn()
        c = conn.cursor()
        c.execute('''UPDATE users SET 
                     name=?, pin=?, q_cookie=?, b_cookie=?, 
                     q_img=?, b_img=?, b_pwd=? 
                     WHERE uid=?''', 
                  (name, pin, q, b, q_img, b_img, b_pwd, uid))
        conn.commit()
        conn.close()

    def delete_user(self, uid):
        conn = self._get_conn()
        c = conn.cursor()
        c.execute("DELETE FROM users WHERE uid=?", (uid,))
        conn.commit()
        conn.close()

db = DBManager()

# ==========================================
# 1. æ ¸å¿ƒ Engine ä¸ Worker (è¯·åŠ¡å¿…å¡«å…¥çœŸå®ä»£ç )
# ==========================================

# ğŸ”´ğŸ”´ğŸ”´ æå…¶é‡è¦ï¼šè¯·åœ¨æ­¤å¤„ç²˜è´´ä½ åŸæœ¬å¥½ç”¨çš„ QuarkEngine, BaiduEngine, JobManager ä»£ç  ğŸ”´ğŸ”´ğŸ”´
# ğŸ”´ğŸ”´ğŸ”´ å¦åˆ™ç¨‹åºæ— æ³•è¿è¡Œè½¬å­˜åŠŸèƒ½ ğŸ”´ğŸ”´ğŸ”´

# --- Mock ä»£ç å¼€å§‹ (ä»…ç”¨äºæ¼”ç¤ºç»“æ„ï¼Œè¯·æ›¿æ¢) ---
# helper functions
def get_time_diff(t): return "1s"
def smart_shorten_url(t): return t
def create_copy_button_html(t): return ""
def extract_smart_folder_name(t, s): return "Res"
def sanitize_filename(n): return n
def send_notification(b, p, t, bo): pass

# Job Manager
@st.cache_resource
class JobManager:
    def __init__(self): self.jobs = {}
    def create_job(self): 
        jid = str(uuid.uuid4())[:8]
        self.jobs[jid] = {"status": "running", "logs": [], "result_text": "", "progress": {"current":0,"total":0}, "created_at": datetime.now(), "summary": {}}
        return jid
    def get_job(self, jid): return self.jobs.get(jid)
    def add_log(self, jid, msg, type="info"): 
        if jid in self.jobs: self.jobs[jid]["logs"].append({"time": "00:00", "msg": msg, "type": type})
    def complete_job(self, jid, text, sum): 
        if jid in self.jobs: 
            self.jobs[jid]["status"]="done"; self.jobs[jid]["result_text"]=text; self.jobs[jid]["summary"]=sum
    def update_progress(self, jid, c, t):
        if jid in self.jobs: self.jobs[jid]["progress"] = {"current": c, "total": t}

job_manager = JobManager()

def worker_thread(job_id, input_text, q_c, b_c, bark, push, img_conf):
    # ğŸ”´ è¯·æ›¿æ¢ä¸ºçœŸå®çš„ worker_thread é€»è¾‘
    time.sleep(1)
    job_manager.complete_job(job_id, input_text + "\n(å¤„ç†å®Œæ¯•)", {"success": 1, "total": 1, "duration": "1s"})
# --- Mock ä»£ç ç»“æŸ ---


# ==========================================
# 2. ç•Œé¢è§†å›¾é€»è¾‘ (UI)
# ==========================================
st.set_page_config(page_title="LinkChanger Pro", page_icon="âš¡", layout="wide")

# ç§»é™¤ç¼“å­˜è£…é¥°å™¨ï¼Œé˜²æ­¢æŠ¥é”™
def get_manager():
    return stx.CookieManager()

# --- ç®¡ç†å‘˜åå° (ç¾åŒ–ç‰ˆ) ---
def page_admin():
    st.title("ğŸ›¡ï¸ æ§åˆ¶å°")
    
    # åå°ç™»å½•
    ADMIN_PWD = st.secrets.get("general", {}).get("admin_password", "admin888")
    if "admin_logged_in" not in st.session_state:
        c1, c2, c3 = st.columns([1, 2, 1])
        with c2:
            st.info("ğŸ”’ ç®¡ç†å‘˜èº«ä»½éªŒè¯")
            pwd = st.text_input("Password", type="password", label_visibility="collapsed")
            if st.button("Unlock Dashboard", type="primary", use_container_width=True):
                if pwd == ADMIN_PWD:
                    st.session_state.admin_logged_in = True
                    st.rerun()
                else:
                    time.sleep(1)
                    st.error("Access Denied")
        return

    # æ•°æ®æ¦‚è§ˆ
    users = db.get_all_users()
    
    # é¡¶éƒ¨æŒ‡æ ‡å¡
    m1, m2, m3 = st.columns(3)
    m1.metric("æ€»ç”¨æˆ·æ•°", len(users))
    m2.metric("æ´»è·ƒç”¨æˆ·", len([u for u in users if u[4] or u[5]])) # æœ‰Cookieå°±ç®—æ´»è·ƒ
    m3.metric("ç³»ç»ŸçŠ¶æ€", "ğŸŸ¢ åœ¨çº¿")
    
    st.divider()

    # ä½¿ç”¨ Tab åˆ†éš”åŠŸèƒ½ï¼Œæ›´æ•´æ´
    tab_list, tab_add = st.tabs(["ğŸ‘¥ ç”¨æˆ·ç®¡ç†", "â• æ·»åŠ ç”¨æˆ·"])

    with tab_list:
        if not users:
            st.info("æš‚æ— ç”¨æˆ·ï¼Œè¯·å»æ·»åŠ ")
        else:
            #ä»¥æ­¤ä¸ºè¡¨å¤´
            st.markdown(
                """
                | æ˜µç§° | UID | å¾®ä¿¡å· | çŠ¶æ€ | æ“ä½œ |
                |---|---|---|---|---|
                """
            )
            for u in users:
                uid, name, wechat, t, q, b = u
                
                # çŠ¶æ€å›¾æ ‡
                status_icon = ""
                if q: status_icon += "ğŸªå¤¸å…‹ "
                if b: status_icon += "ğŸªç™¾åº¦"
                if not status_icon: status_icon = "âšªæœªé…ç½®"

                c1, c2, c3, c4, c5 = st.columns([2, 2, 2, 2, 1])
                c1.write(f"**{name}**")
                c2.code(uid)
                c3.write(wechat)
                c4.caption(status_icon)
                if c5.button("ğŸ—‘ï¸", key=f"del_{uid}", help="åˆ é™¤è¯¥ç”¨æˆ·"):
                    db.delete_user(uid)
                    st.toast(f"ç”¨æˆ· {name} å·²åˆ é™¤")
                    time.sleep(1)
                    st.rerun()
                st.markdown("---") # åˆ†å‰²çº¿

    with tab_add:
        st.markdown("#### åˆ›å»ºä¸“å±é“¾æ¥")
        with st.form("add_user_form", border=False):
            c1, c2 = st.columns(2)
            new_uid = c1.text_input("è‡ªå®šä¹‰ UID (å¦‚: vip888, tony)", help="è¿™æ˜¯ç”¨æˆ·å”¯ä¸€çš„ç™»å½•å‡­è¯")
            new_name = c2.text_input("ç”¨æˆ·æ˜µç§°")
            
            c3, c4 = st.columns(2)
            new_wechat = c3.text_input("ç»‘å®šå¾®ä¿¡å· (ä»…è®°å½•)")
            new_pin = c4.text_input("åˆå§‹å¯†ç  (ç”¨æˆ·å¯ä¿®æ”¹)", value="123456")
            
            submitted = st.form_submit_button("âœ¨ ç«‹å³åˆ›å»º", type="primary")
            if submitted:
                if not new_uid or not new_name:
                    st.error("UID å’Œ æ˜µç§° å¿…é¡»å¡«å†™")
                else:
                    ok, msg = db.add_user(new_uid, new_name, new_pin, new_wechat)
                    if ok:
                        st.success(f"âœ… ç”¨æˆ· {new_name} åˆ›å»ºæˆåŠŸï¼")
                        st.code(f"?uid={new_uid}", language="text")
                        st.caption("ğŸ‘† æŠŠè¿™ä¸ªåç¼€å‘ç»™ç”¨æˆ·å³å¯")
                    else:
                        st.error(msg)

# --- ç”¨æˆ·å·¥å…·é¡µ (åŠŸèƒ½é¡µ) ---
def page_user_tool(uid):
    user_data = db.get_user(uid)
    if not user_data:
        st.error("âŒ è´¦å·å¼‚å¸¸")
        return

    # === ä¾§è¾¹æ  ===
    with st.sidebar:
        st.header(f"ğŸ‘¤ {user_data['name']}")
        
        with st.expander("âš™ï¸ è´¦å·é…ç½®", expanded=False):
            st.caption("ID: " + uid)
            
            # ä½¿ç”¨ Form é˜²æ­¢æ¯æ¬¡è¾“å…¥ä¸€ä¸ªå­—éƒ½åˆ·æ–°
            with st.form("profile_form"):
                st.write("**åŸºæœ¬ä¿¡æ¯**")
                new_name = st.text_input("æ˜µç§°", value=user_data['name'])
                new_pin = st.text_input("å¯†ç ", value=user_data['pin'], type="password")
                
                st.write("**ç½‘ç›˜ Cookie (æ ¸å¿ƒ)**")
                new_q = st.text_area("å¤¸å…‹ Cookie", value=user_data['q'], height=80)
                new_b = st.text_area("ç™¾åº¦ Cookie", value=user_data['b'], height=80)
                
                st.write("**å¹¿å‘Šæ¤å…¥ (å¯é€‰)**")
                new_q_img = st.text_input("å¤¸å…‹å¹¿å‘Šé“¾", value=user_data['q_img'])
                new_b_img = st.text_input("ç™¾åº¦å¹¿å‘Šé“¾", value=user_data['b_img'])
                new_b_pwd = st.text_input("ç™¾åº¦æå–ç ", value=user_data['b_pwd'])
                
                if st.form_submit_button("ğŸ’¾ ä¿å­˜é…ç½®"):
                    db.update_user_profile(
                        uid, new_name, new_pin, 
                        new_q, new_b, 
                        new_q_img, new_b_img, new_b_pwd
                    )
                    st.toast("é…ç½®å·²ä¿å­˜ï¼", icon="âœ…")
                    time.sleep(0.5)
                    st.rerun()

        if st.button("ğŸšª é€€å‡ºç™»å½•", use_container_width=True):
             get_manager().delete(f"auth_{uid}")
             # æ¸…é™¤ session state
             if f"auth_{uid}" in st.session_state:
                 del st.session_state[f"auth_{uid}"]
             st.query_params.clear()
             st.rerun()

    # === ä¸»ç•Œé¢ ===
    st.subheader(f"âš¡ æ¬¢è¿, {user_data['name']}")
    
    # çŠ¶æ€æ 
    col1, col2 = st.columns([3, 1])
    with col1:
        if not user_data['q'] and not user_data['b']:
            st.warning("âš ï¸ å°šæœªé…ç½®ä»»ä½• Cookieï¼Œæ— æ³•å·¥ä½œã€‚è¯·ç‚¹å‡»å·¦ä¾§é…ç½®ã€‚")
        else:
            tags = []
            if user_data['q']: tags.append("âœ…å¤¸å…‹")
            if user_data['b']: tags.append("âœ…ç™¾åº¦")
            st.caption("å°±ç»ªå¼•æ“: " + " / ".join(tags))
            
    # ä»»åŠ¡æäº¤åŒº
    with st.container(border=True):
        input_text = st.text_area("åœ¨æ­¤ç²˜è´´åˆ†äº«é“¾æ¥ (æ”¯æŒæ‰¹é‡æ··åˆ)", height=150, placeholder="https://pan.quark.cn/s/...\nhttps://pan.baidu.com/s/...")
        
        if st.button("ğŸš€ ç«‹å³è½¬å­˜", type="primary", use_container_width=True):
            if not input_text.strip():
                st.toast("è¯·å…ˆç²˜è´´é“¾æ¥", icon="âš ï¸")
            elif not user_data['q'] and not user_data['b']:
                st.error("è¯·å…ˆåœ¨å·¦ä¾§é…ç½® Cookie")
            else:
                jid = job_manager.create_job()
                img_conf = {
                    "quark": {"url": user_data['q_img'], "enabled": bool(user_data['q_img'])},
                    "baidu": {"url": user_data['b_img'], "pwd": user_data['b_pwd'], "enabled": bool(user_data['b_img'])}
                }
                
                t = threading.Thread(target=worker_thread, args=(
                    jid, input_text, 
                    user_data['q'], user_data['b'], 
                    "", "", img_conf
                ))
                t.start()
                st.query_params["job_id"] = jid
                st.query_params["uid"] = uid
                st.rerun()

    # ç»“æœå›æ˜¾åŒº (å¤ç”¨)
    curr_jid = st.query_params.get("job_id")
    if curr_jid:
        job = job_manager.get_job(curr_jid)
        if job:
            with st.status(f"ä»»åŠ¡çŠ¶æ€: {job['status']}", expanded=True) as status:
                if job['status'] == 'done':
                    status.update(label="âœ… å¤„ç†å®Œæˆ", state="complete", expanded=True)
                    st.text_area("æœ€ç»ˆç»“æœ", value=job['result_text'], height=150)
                else:
                    st.write("æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...")
                
                # ç®€æ˜“æ—¥å¿—
                for log in job['logs']:
                    st.text(f"{log['msg']}")
            
            if job['status'] == 'done':
                if st.button("å¼€å§‹æ–°ä»»åŠ¡"):
                    st.query_params["job_id"] = ""
                    st.query_params["uid"] = uid
                    st.rerun()

# ==========================================
# 3. ç¨‹åºå…¥å£ (Main)
# ==========================================
def main():
    # URL å‚æ•°
    uid_param = st.query_params.get("uid", None)
    HIDDEN_ADMIN_UID = st.secrets.get("general", {}).get("admin_uid", "admin_entry_default")

    # 1. 403 ç¦æ­¢è®¿é—®
    if not uid_param:
        st.markdown(
            """
            <style>
            .stApp {align-items: center; justify-content: center;}
            </style>
            <div style="text-align:center; margin-top: 100px;">
                <h1>ğŸš« Access Denied</h1>
                <p>Private Tool. Invitation Only.</p>
            </div>
            """, 
            unsafe_allow_html=True
        )
        return

    # 2. ç®¡ç†å‘˜
    if uid_param == HIDDEN_ADMIN_UID:
        page_admin()
        return

    # 3. ç”¨æˆ·ç™»å½•é€»è¾‘
    user_data = db.get_user(uid_param)
    if not user_data:
        st.error("ğŸš« æ— æ•ˆçš„é“¾æ¥ (UID Invalid)")
        return
    
    # ä¿®å¤ï¼šä¼˜å…ˆæ£€æŸ¥ Session State (ç§’è¿›)ï¼Œå…¶æ¬¡æ£€æŸ¥ Cookie
    session_key = f"auth_{uid_param}"
    
    # å¦‚æœ Session é‡Œå·²ç»æ ‡è®°å·²ç™»å½•ï¼Œç›´æ¥è¿›
    if st.session_state.get(session_key):
        page_user_tool(uid_param)
        return

    # å¦‚æœæ²¡æœ‰ Sessionï¼Œæ£€æŸ¥ Cookie
    cookie_manager = get_manager()
    cookie_val = cookie_manager.get(session_key)
    
    if cookie_val == "logged_in":
        # Cookie æœ‰æ•ˆï¼ŒåŒæ­¥å†™å…¥ Session å¹¶è¿›å…¥
        st.session_state[session_key] = True
        page_user_tool(uid_param)
        return
    
    # 4. æ˜¾ç¤ºé”å±ç•Œé¢
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        st.markdown(f"### ğŸ”’ Welcome, {user_data['name']}")
        pin_input = st.text_input("Enter Password", type="password")
        
        if st.button("Login", type="primary", use_container_width=True):
            if pin_input == user_data['pin']:
                # ç™»å½•æˆåŠŸåŒé‡æ ‡è®°ï¼š1.å†™Cookie(æŒä¹…åŒ–) 2.å†™Session(å³æ—¶ç”Ÿæ•ˆ)
                cookie_manager.set(session_key, "logged_in", expires_at=datetime.now() + timedelta(days=30))
                st.session_state[session_key] = True
                st.rerun()
            else:
                time.sleep(0.5)
                st.error("Incorrect Password")

if __name__ == "__main__":
    main()
